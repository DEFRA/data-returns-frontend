<script type="text/javascript">
    (function () {
        var $uploader = $("#uploader-container");
        var $template = $("#fu-template");
        $uploader.html($template.html());

        var $uploadList = $("#upload-list");
        var $resultTemplate = $("#fur-template");

        /*
         * Update the file status list.
         */
        var setFileStatus = function(details) {
            if (details && details.id) {
                console.log("Updating details for " + details.id + " (" + details.name + ")");
                $(".upload-list-no-files").hide();

                var rowId = "summary-" + details.id;
                var $uploadRow = $uploadList.children("#" + rowId);

                if (!$uploadRow.length) {
                    // No existing row for this file.  Create a new row
                    $uploadRow = $($resultTemplate.html());
                    $uploadRow.attr("id", rowId);
                    $uploadList.append($uploadRow);
                }

                $uploadRow.find(".filename").html(details.name);
                var $statusDiv = $uploadRow.find(".status");
                $statusDiv.empty();
                var $innerStatusDiv = $("<div>");
                $statusDiv.append($innerStatusDiv);
                $innerStatusDiv.html(details.status.description);
                $innerStatusDiv
                        .removeClass("file-success file-error file-pending")
                        .addClass("file-" + details.status.state);
                if (details.status.state === "pending") {
                  // Add aria tags
                  $innerStatusDiv.attr("aria-live", "assertive");
                  $innerStatusDiv.attr("aria-busy", "true");
                  $innerStatusDiv.attr("role", "alertdialog");
                } else {
                  // Remove aria tags
                  $innerStatusDiv.remmoveAttr("aria-live");
                  $innerStatusDiv.remmoveAttr("aria-busy");
                  $innerStatusDiv.remmoveAttr("role");
                }

                var moreDetailsHtml = "";
                if (details.status.moreDetailsUrl != null) {
                    moreDetailsHtml = "<a href=\"" + details.status.moreDetailsUrl + "\">More details</a>";
                }
                $uploadRow.find(".details").html(moreDetailsHtml);
                $uploadRow.find(".file-uuid").val(details.id);
            }
        };

        new qq.DragAndDrop({
            dropZoneElements: [document.body],
            classes: {
                dropActive: "file-drop-active"
            },
            callbacks: {
                processingDroppedFilesComplete: function(files) {
                    if (files && files.length > 0) {
                        fileUploader.addFiles(files);
                    }
                }
            }
        });
        var fileUploader = new qq.FineUploaderBasic({
            element: document.getElementById("uploader-container"),
            button: document.getElementById("choose-file-button"),
            debug: false,
            autoUpload: true,
            multiple: true,
            disableCancelForFormUploads: true,
            validation: {
                stopOnFirstInvalidFile: false
            },
            request: {
                endpoint: "/file/choose?fineuploader=true",
                inputName: "fileUpload",
                method: "POST",
                // Use request parameters rather than encoding data in body (allows us to handle max file size server-side)
                paramsInBody: false
            },
            chunking: {
                enabled: false
            },
            cors: {
                allowXdr: false
            },
            resume: {
                enabled: true
            },
            retry: {
                enableAuto: false
            },
            text: {
                defaultResponseError: "Unable to upload file"
            },
            messages: {
                emptyError: "File is empty",
                noFilesError: null
            },
            callbacks: {
                onError: function(id, name, errorReason, xhrOrXdr) {
                    var uuid = "Unsubmitted" + Math.random();
                    if (id != null) {
                        uuid = fileUploader.getUuid(id);
                    }
                    var responseJSON  = {
                        "id": uuid,
                        "name": name,
                        "status": {
                            "state": "error",
                            "description": errorReason
                        }
                    };

                    try {
                        if (xhrOrXdr) {
                            responseJSON = JSON.parse(xhrOrXdr.responseText);
                        }
                    } catch (e) {}
                    setFileStatus(responseJSON);
                },
                onComplete: function(id, name, responseJSON, xhr) {
                    setFileStatus(responseJSON.details);
                },
                onAllComplete: function(succeeded, failed) {
                    $.getJSON( "/file/choose?status=true", function(status) {
                        var $continue = $("#continue-btn");
                        if (status.canContinue) {
                            $continue.removeAttr("disabled");
                            $continue.attr("href", "/file/confirm");
                            $continue.removeAttr("aria-disabled");
                        } else {
                            $continue.attr("disabled", "disabled");
                            $continue.removeAttr("href");
                            $continue.attr("aria-disabled", "true");
                        }

                        var $invalidMsg = $("#invalid-upload-msg");
                        $invalidMsg.toggle(status.hasInvalidUploads);
                    });
                },
                onSubmit: function(id, name) {
                    var details = {
                        "id": fileUploader.getUuid(id),
                        "name": name,
                        "status": {
                            "state": "pending",
                            "description": "Checking "
                        }
                    };
                    setFileStatus(details);
                }
              }
        });
    }())
</script>
